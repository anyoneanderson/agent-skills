# spec-implement ガイド

## 概要

spec-implement は、プロジェクト固有の設定ファイルを読み込み、構造化された仕様書からタスクを実行することで、実装からPR作成までのワークフローを自動化します。

実行エンジンとして以下を行います:
- `docs/issue-to-pr-workflow.md` を開発プレイブックとして読み込む
- `docs/coding-rules.md` を品質ゲートとして強制適用する
- `.specs/{feature}/tasks.md` のチェックボックスで進捗を追跡する
- 完了後にPRを作成する

## 全体実行フロー

```
1. 初期チェック
   ├── 作業ディレクトリの確認（gitリポジトリ、gh CLI利用可能）
   ├── オプション解析（--resume, --issue, --spec, --dry-run）
   └── specディレクトリの特定（.specs/{feature}/）

2. ファイル読み込み
   ├── docs/issue-to-pr-workflow.md（プレイブック）
   ├── docs/coding-rules.md（品質ルール）
   ├── .specs/{feature}/requirement.md
   ├── .specs/{feature}/design.md
   └── .specs/{feature}/tasks.md

3. Issue分析
   ├── gh issue view {number} でコンテキスト取得
   └── 要件、ラベル、アサイニーの抽出

4. ブランチ作成
   └── ワークフローの命名規則に従う（デフォルト: feature/issue-{N}-{desc}）

5. タスクループ
   ├── tasks.mdから次の未完了タスクを読み取り
   ├── design.mdを参照して実装の詳細を確認
   ├── タスクを実装
   ├── 品質チェック実行（coding-rules.md）
   ├── tasks.mdのチェックボックスを更新（- [ ] → - [x]）
   └── 進捗をコミット

6. 最終品質ゲート
   ├── 全テスト実行（ワークフローから）
   ├── lint/typecheck実行（ワークフローから）
   └── 全[MUST]ルールの通過を確認

7. PR作成
   ├── ワークフローのPRテンプレートに従う
   ├── Issueにリンク（Closes #{N}）
   └── CI監視（ワークフローに記述がある場合）
```

## ワークフローファイルの読み込み

### `docs/issue-to-pr-workflow.md` の使われ方

ワークフローファイルは、spec-implement がセクションごとに読んで従うプロジェクト固有のプレイブックです。通常以下のセクションを含みます:

| セクション | spec-implement が抽出する内容 |
|-----------|-------------------------------|
| Development Environment | 環境セットアップコマンド、コンテナ起動コマンド |
| Issue Analysis and Setup | ブランチ命名規則、Issue読み取り手順 |
| Phased Implementation | 実装の順序、コーディングガイドライン |
| Testing | テストコマンド、カバレッジ閾値 |
| PR Creation and Quality Gates | PR前チェック、PR本文テンプレート |
| CI/CD Monitoring | CI確認コマンド |

**重要な原則**: spec-implement はプロジェクト固有のコマンドをハードコードしません。すべてのコマンドはワークフローファイルから読み取ります。

### ワークフローファイルが存在しない場合

`docs/issue-to-pr-workflow.md` が存在しない場合:
1. 警告メッセージを表示
2. spec-workflow-init を実行してワークフローを生成するか確認
3. 辞退された場合、内蔵のミニマルフローを使用:
   - Issue分析 → ブランチ作成 → タスク実装 → テスト実行 → PR作成

## コーディングルールの読み込み

### `docs/coding-rules.md` の使われ方

ルールファイルは、3段階の強制度を持つプロジェクト固有の品質基準を定義します:

| 強制度 | 違反時の動作 | 例 |
|--------|-------------|-----|
| `[MUST]` | エラー — 修正するまで続行不可 | 「すべての関数に戻り値の型を記述すること」 |
| `[SHOULD]` | 警告 — 記録して続行 | 「letよりconstを優先すること」 |
| `[MAY]` | 情報 — ログ記録のみ | 「JSDocコメントの追加を検討すること」 |

ルールは4つのタイミングでチェックされます:
1. **タスク開始前**: タスクカテゴリに関連するルールを確認
2. **コード生成時**: 生成コードを`[MUST]`ルールに照らして自己チェック
3. **タスク完了時**: 完了条件 + ルール準拠を確認
4. **最終ゲート**: 全変更に対して全`[MUST]`ルールをチェック

### ルールファイルが存在しない場合

`docs/coding-rules.md` が存在しない場合:
1. 警告メッセージを表示
2. spec-rules-init を実行してルールを生成するか確認
3. 辞退された場合、ルール強制なしで実装を続行
4. CLAUDE.md や AGENTS.md が存在すればフォールバック参照として使用

## tasks.md の状態管理

### チェックボックスの形式

tasks.md は標準的なMarkdownチェックボックスで状態を追跡します:

```markdown
### Phase 1: セットアップ
- [ ] T001: プロジェクト構造の作成     ← 未チェック = 未完了
- [x] T002: データベースの初期化       ← チェック済み = 完了

### Phase 2: 実装
- [ ] T003: ユーザーモデルの実装
  - 完了条件:
    - [x] モデルクラスの作成           ← サブ項目も追跡
    - [ ] バリデーションルールの追加
    - [ ] ユニットテストの作成
```

### チェックボックスの更新方法

1. タスク開始時: すべての完了条件を満たすまでトップレベルのチェックボックスは `- [ ]` のまま
2. サブ基準の完了時: 個別のサブチェックボックスを `- [x]` に更新
3. 全基準通過時: トップレベルのチェックボックスを `- [x]` に更新
4. 更新後: 変更をコミットして進捗を保存

### コミット戦略

各タスク完了後:
```
git add .specs/{feature}/tasks.md [+ 実装ファイル]
git commit -m "feat: T001 完了 — {簡潔な説明}"
```

これにより、エージェントが予期せず停止しても進捗が保存されます。

## --resume の動作

`--resume` オプションは、最後の未完了タスクからの続行を可能にします:

```
1. tasks.md を読み込む
2. すべてのトップレベルチェックボックスをスキャン
3. 最初の未チェックタスク（- [ ]）を特定
4. サブ基準を確認:
   - すべて未チェック → タスクを最初から開始
   - 一部チェック済み → 最初の未チェック基準から続行
5. 残りのタスクを順番に実行
```

### 再開シナリオ

| シナリオ | 動作 |
|----------|------|
| 全タスクチェック済み | 「全タスク完了」と報告し、最終ゲートへ進む |
| 最初のタスクが未チェック | 最初から開始 |
| 途中のタスクが未チェック | 完了済みタスクをスキップし、未チェックから続行 |
| サブ基準が一部完了 | タスク内の未チェック基準から再開 |

## トラブルシューティング

### よくある問題

**「workflow.md が見つかりません」**
- `spec-workflow-init` を実行してワークフローファイルを生成
- または内蔵のミニマルフローで続行

**「coding-rules.md が見つかりません」**
- `spec-rules-init` を実行してルールファイルを生成
- またはルール強制なしで続行

**「tasks.md が見つかりません」**
- この機能に対して spec-generator を実行済みか確認
- または `--issue` を使用してミニマルモード（Issueのみ）で実行

**「gh CLIが認証されていません」**
- `gh auth login` を実行して認証
- リポジトリへの書き込み権限があることを確認

**タスクループが停滞しているように見える**
- `[MUST]` ルール違反が進行をブロックしていないか確認
- エラーメッセージを確認して違反を修正
- 修正後に `--resume` で続行

**エージェントがタスクの途中で停止した**
- `--resume` を使用して最後のチェックポイントから続行
- git log で最後にコミットされた進捗を確認
- tasks.md のチェックボックスが実行停止位置を正確に示す

### 安全機構

spec-implement には以下の安全装置が含まれています:
- force push を行わない
- main/master への直接 push を行わない
- テスト失敗時のPR作成をブロック
- 大規模なコード削除前にユーザー確認を求める
- 各タスク完了後に進捗をコミットして復旧可能性を確保
